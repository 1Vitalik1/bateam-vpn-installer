#!/bin/bash

#################################################
# Zapret Configuration (GoodbyeDPI for Linux)
# DPI bypass settings
#################################################

# Operating mode
# tpws - transparent proxy mode (recommended for most cases)
# nfqws - netfilter queue mode (more advanced, may work better in some cases)
MODE="${MODE:-tpws}"

# Enable IPv6 support
DISABLE_IPV6="${DISABLE_IPV6:-1}"

# TPWS (Transparent Proxy) Settings
# Port for transparent proxy
TPWS_PORT="${TPWS_PORT:-988}"

# TPWS options for bypassing DPI
# --split-pos=2 - split packet at position 2
# --split-http-req=method - split HTTP request at method
# --disorder - send packets in disorder
# --oob - send out-of-band data
TPWS_OPT="${TPWS_OPT:---split-pos=2 --split-http-req=method --disorder --oob}"

# Additional TPWS options for HTTPS
TPWS_OPT_HTTPS="${TPWS_OPT_HTTPS:---split-pos=2 --disorder --oob}"

# NFQWS (Netfilter Queue) Settings
# Queue number for NFQUEUE
NFQWS_QUEUE="${NFQWS_QUEUE:-200}"

# NFQWS options for HTTP
# --dpi-desync=split2 - use split desync method
# --dpi-desync-ttl=5 - set TTL to 5 for fake packets
# --dpi-desync-fooling=badseq - use bad sequence numbers
NFQWS_OPT_DESYNC="${NFQWS_OPT_DESYNC:---dpi-desync=split2}"
NFQWS_OPT_DESYNC_HTTP="${NFQWS_OPT_DESYNC_HTTP:---dpi-desync-ttl=5 --dpi-desync-fooling=badseq}"
NFQWS_OPT_DESYNC_HTTPS="${NFQWS_OPT_DESYNC_HTTPS:---dpi-desync-ttl=5 --dpi-desync-fooling=badseq}"

# Domain lists
# List of domains to process (one per line)
# If empty, process all traffic
HOSTLIST="${HOSTLIST:-}"
HOSTLIST_EXCLUDE="${HOSTLIST_EXCLUDE:-}"

# Auto hostlist mode
# auto - automatically detect blocked domains
# force - use only specified domains
AUTOHOSTLIST="${AUTOHOSTLIST:-}"

# Firewall type
# nftables or iptables
FWTYPE="${FWTYPE:-iptables}"

# Interface to apply rules
# tun+ - all tun interfaces (VPN)
# eth0 - specific interface
IFACE_LAN="${IFACE_LAN:-tun+}"

# Ports to process
# 80 - HTTP
# 443 - HTTPS
PORTS_HTTP="${PORTS_HTTP:-80}"
PORTS_HTTPS="${PORTS_HTTPS:-443}"

# Process all traffic or only specific domains
# 0 - process only domains from HOSTLIST
# 1 - process all traffic
PROCESS_ALL="${PROCESS_ALL:-1}"

# User to run as
ZAPRET_USER="${ZAPRET_USER:-nobody}"

# Working directory
ZAPRET_BASE="${ZAPRET_BASE:-/opt/zapret}"

# Log settings
LOG_LEVEL="${LOG_LEVEL:-1}"

# Advanced options

# Fragment size for splitting packets
DESYNC_SPLIT_POS="${DESYNC_SPLIT_POS:-2}"

# TTL value for fake packets
DESYNC_TTL="${DESYNC_TTL:-5}"

# Fooling methods:
# none - no fooling
# md5sig - add fake MD5 signature
# badseq - use bad sequence number
# badsum - use bad checksum
# hopbyhop - use hop-by-hop IPv6 header
DESYNC_FOOLING="${DESYNC_FOOLING:-badseq}"

# Strategy for packet splitting
# none - no splitting
# disorder - send packets in wrong order
# disorder2 - advanced disorder
# split - simple split
# split2 - split with offset
DESYNC_STRATEGY="${DESYNC_STRATEGY:-split2}"

# Custom iptables rules
# Add your custom rules here if needed
CUSTOM_IPTABLES_RULES="${CUSTOM_IPTABLES_RULES:-}"

# Enable/disable specific features
ENABLE_HTTP="${ENABLE_HTTP:-1}"
ENABLE_HTTPS="${ENABLE_HTTPS:-1}"

# Whitelist/Blacklist mode
# whitelist - process only listed domains
# blacklist - process all except listed
LIST_MODE="${LIST_MODE:-blacklist}"

# Performance tuning
# Number of worker threads
WORKERS="${WORKERS:-4}"

# Buffer sizes (bytes)
SNDBUF="${SNDBUF:-262144}"
RCVBUF="${RCVBUF:-262144}"

#################################################
# Country-specific presets
#################################################

# Russia preset
if [ "$COUNTRY_PRESET" = "russia" ]; then
    TPWS_OPT="--split-pos=2 --split-http-req=method --disorder --oob --tlsrec=sni"
    NFQWS_OPT_DESYNC="--dpi-desync=split2 --dpi-desync-split-pos=2"
    NFQWS_OPT_DESYNC_HTTPS="--dpi-desync-ttl=5 --dpi-desync-fooling=badseq,md5sig"
fi

# China preset
if [ "$COUNTRY_PRESET" = "china" ]; then
    TPWS_OPT="--split-pos=3 --split-http-req=host --disorder"
    NFQWS_OPT_DESYNC="--dpi-desync=disorder2 --dpi-desync-split-pos=3"
    NFQWS_OPT_DESYNC_HTTPS="--dpi-desync-ttl=4 --dpi-desync-fooling=md5sig"
fi

# Iran preset
if [ "$COUNTRY_PRESET" = "iran" ]; then
    TPWS_OPT="--split-pos=2 --disorder --oob"
    NFQWS_OPT_DESYNC="--dpi-desync=split2 --dpi-desync-split-pos=2"
    NFQWS_OPT_DESYNC_HTTPS="--dpi-desync-ttl=6 --dpi-desync-fooling=badseq"
fi

# Turkey preset
if [ "$COUNTRY_PRESET" = "turkey" ]; then
    TPWS_OPT="--split-pos=2 --split-http-req=method --disorder"
    NFQWS_OPT_DESYNC="--dpi-desync=split --dpi-desync-split-pos=2"
    NFQWS_OPT_DESYNC_HTTPS="--dpi-desync-ttl=5 --dpi-desync-fooling=badseq"
fi

#################################################
# Export all variables
#################################################

export MODE DISABLE_IPV6 TPWS_PORT TPWS_OPT TPWS_OPT_HTTPS
export NFQWS_QUEUE NFQWS_OPT_DESYNC NFQWS_OPT_DESYNC_HTTP NFQWS_OPT_DESYNC_HTTPS
export HOSTLIST HOSTLIST_EXCLUDE AUTOHOSTLIST
export FWTYPE IFACE_LAN PORTS_HTTP PORTS_HTTPS
export PROCESS_ALL ZAPRET_USER ZAPRET_BASE LOG_LEVEL
export DESYNC_SPLIT_POS DESYNC_TTL DESYNC_FOOLING DESYNC_STRATEGY
export ENABLE_HTTP ENABLE_HTTPS LIST_MODE WORKERS SNDBUF RCVBUF